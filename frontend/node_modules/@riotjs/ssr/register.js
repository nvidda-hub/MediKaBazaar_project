'use strict';

var pirates = require('pirates');
var compiler = require('@riotjs/compiler');
var core = require('@babel/core');

// returns the teardown function
var register = (options) => pirates.addHook(
  function(source, filename) {
    const {code} = compiler.compile(source, { file: filename });

    return core.transform(code, {
      presets: [
        [
          '@babel/preset-env',
          {
            modules: 'cjs',
            targets: {
              node: process.versions.node
            }
          }
        ]
      ]
    }).code
  },
  {
    exts: ['.riot'],
    ignoreNodeModules: false,
    ...options
  }
);

module.exports = register;
